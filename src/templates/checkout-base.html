{% extends "columnar-base.html" %}

{% block head %}
<script id="script-utils">
  function getOptions() {
    var formData = new FormData(document.getElementById('options-form'))
    var formOptions = Object.fromEntries(formData)
    formOptions['partner-id'] = document.getElementById('partner-id').value
    formOptions['client-id'] = document.getElementById('partner-client-id').value
    formOptions['merchant-id'] = document.getElementById('merchant-id').value
    formOptions['bn-code'] = document.getElementById('bn-code').value
    return formOptions
  }
  function copyToClipboard(id) {
    navigator.clipboard.writeText(document.getElementById(id).value)
  }
  function updateAPICalls(formattedCalls) {
    document.getElementById('api-calls').click()
    for (var id in formattedCalls) {
      if (formattedCalls.hasOwnProperty(id)) {
        var contents = formattedCalls[id]
        var apiCallTab = document.getElementById('api-calls-' + id)
        apiCallTab.innerHTML = contents
        var apiCallsButton = document.getElementById(id)
        enableButton(apiCallsButton)
        apiCallsButton.click()
      }
    }
  }
  function enableButton(button) {
    const disabledClassList = ["text-zinc-500", "dark:text-zinc-500", "cursor-not-allowed", "hidden"]
    const enabledClassList = ["hover:text-zinc-700", "hover:bg-zinc-100/50", "dark:hover:text-zinc-300", "dark:hover:bg-zinc-700/50"]

    button.classList.remove(...disabledClassList)
    button.classList.add(...enabledClassList)
  }
  function makeActiveButton(buttonList, button) {
    const activeClassList = ["text-blue-600", "bg-zinc-200/50", "dark:text-blue-500", "dark:bg-zinc-600/50", "active"]
    const inactiveClassList = ["hover:text-zinc-700", "hover:bg-zinc-100/50", "dark:hover:text-zinc-300", "dark:hover:bg-zinc-700/50"]

    buttonList.forEach(each => {
      each.classList.remove(...activeClassList)
      each.classList.add(...inactiveClassList)
    })

    button.classList.remove(...inactiveClassList)
    button.classList.add(...activeClassList)
  }
  function makeActiveTab(tabList, tab) {
    tabList.forEach(each => {each.classList.add("hidden");})
    tab.classList.remove("hidden")
  }
</script>
<script>
  function populateForm() {
    // Extract querystring parameters and populate form accordingly.
    const params = new Proxy(new URLSearchParams(window.location.search), {
      get: (searchParams, prop) => searchParams.get(prop),
    })
    const intent = params.intent
    document.getElementById('intent').value = intent

    const shippingPreference = params['shipping-preference']
    document.getElementById('shipping-preference').value = shippingPreference

    const price = params.price
    document.getElementById('price').value = price || 3.14

    const referenceID = params['reference-id']
    document.getElementById('reference-id').value = referenceID || ''

    const partnerFee = params['partner-fee']
    document.getElementById('partner-fee').value = partnerFee || 0

    const itemCategory = params['item-category']
    document.getElementById('item-category').value = itemCategory

    const BAToken = params['ba-token']
    document.getElementById('ba-token').value = BAToken || ''
  }
  // populateForm()
</script>
<script id="script-pp-utils">
  async function buildScriptElement(onload) {
    const options = getOptions()
    const url = new URL('https://www.paypal.com/sdk/js')
    url.searchParams.append("client-id", options['client-id'])
    url.searchParams.append("merchant-id", options['merchant-id'])
    url.searchParams.append("intent", options['intent'].toLowerCase())
    url.searchParams.append("currency", options['currency'])
    url.searchParams.append("commit", true)
    url.searchParams.append("enable-funding", "venmo,paylater")

    const oldScriptElement = document.getElementById('paypal-js-sdk')
    if (oldScriptElement.hasAttribute('src')) {
      const oldScriptURL = new URL(oldScriptElement.src)
      if (oldScriptURL.searchParams.has('components')) {
        const components = oldScriptURL.searchParams.get('components')
        url.searchParams.append('components', components)
      }
    }

    const newScriptElement = document.createElement('script')
    newScriptElement.id = 'paypal-js-sdk'
    newScriptElement.src = url.href
    if (oldScriptElement.hasAttribute('data-client-token')) {
      const dataClientToken = oldScriptElement.getAttribute('data-client-token')
      newScriptElement.setAttribute('data-client-token', dataClientToken)
    }

    const BNCode = options['bn-code']
    newScriptElement.setAttribute('data-partner-attribution-id', BNCode)
    newScriptElement.onload = onload

    oldScriptElement.replaceWith(newScriptElement)
  }
  async function resetCheckoutContainer() {
    const containerID = 'paypal-button-container'

    const newContainer = document.createElement('div')
    newContainer.setAttribute('id', containerID)

    const oldContainer = document.getElementById(containerID)
    oldContainer.replaceWith(newContainer)
  }
</script>
{% endblock %}

{% block foot %}
<script id="script-initial-api-calls">
  const formattedCalls = {{ formatted_calls|default('null')| safe }}
  if (formattedCalls !== null) {
    updateAPICalls(formattedCalls)
  }
</script>
<script id="script-init-tabs">
  (function initializeTopLevelButtons() {
    const root = document.querySelector("#buttons-tabs")
    const buttonContainer = root.querySelector("#buttons")
    const tabContainer = root.querySelector("#tabs")
    const buttonList = buttonContainer.querySelectorAll(".button")
    const tabList = root.querySelectorAll("#tabs > .tab")
    buttonContainer.onclick = function(e) {
      var button = e.target
      var buttonId = button.getAttribute("id")
      if (buttonId != null){
        makeActiveButton(buttonList, button)

        var tab = document.getElementById("tab-" + buttonId)
        if (tab === null) {
          console.log("document.getElementById('tab-" + buttonId + "') found null!")
        } else {
          makeActiveTab(tabList, tab)
        }
      }
    }
  })();

  (function initializeApiCallButtons() {
    const apiCallsRoot = document.querySelector("#api-calls-buttons-tabs")
    const apiCallsButtonContainer = apiCallsRoot.querySelector("#api-calls-buttons")
    const apiCallsTabContainer = apiCallsRoot.querySelector("#api-calls-tabs")
    const apiCallsButtonList = apiCallsButtonContainer.querySelectorAll(".button")
    const apiCallsTabList = apiCallsRoot.querySelectorAll("#api-calls-tabs > .tab")
    apiCallsButtonContainer.onclick = function(e) {
      var button = e.target
      var buttonId = button.getAttribute("id")
      if (buttonId != null && !button.classList.contains("cursor-not-allowed")) {
        makeActiveButton(apiCallsButtonList, button)

        var tab = document.getElementById("tab-" + buttonId)
        if (tab === null) {
          console.log("document.getElementById('tab-" + buttonId + "') found null!")
        } else {
          makeActiveTab(apiCallsTabList, tab)
        }
      }
    }
  })();
  document.getElementById("checkout").click()
</script>
{% endblock %}

{% block left_col %}
<form id="options-form" class="space-y-4">
  <div class="text-lg underline">
    Alice - A PPCP Testing Tool
  </div>
  <fieldset>
    <legend class="block mb-2 semibold">
      SDK Options
    </legend>
    <div class="ml-2">
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="intent" class="basis-1/3">
          Intent
        </label>
        <select name="intent" id="intent" class="
        leading-none
        px-2
        py-1
        basis-2/3
        grow
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
          <option value="CAPTURE" selected>Capture</option>
          <option value="AUTHORIZE">Authorize</option>
        </select>
      </div>
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="currency" class="basis-1/3">
          Currency
        </label>
        <select name="currency" id="currency" class="
        leading-none
        px-2
        py-1
        basis-2/3
        grow
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
          <option value="USD" selected>USD</option>
        </select>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend class="block mb-2 font-semibold">Partner/merchant info</legend>
    <div class="ml-2">
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="partner-id" class="
        basis-1/3
        shrink-0
        ">
          Partner ID
        </label>
        <input id="partner-id" name="partner-id" value="{{ partner_id }}" disabled class="
        appearance-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/5
        border
        rounded
        leading-none
        font-mono
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:border-blue-500
        ">
        <button type="button" onclick="copyToClipboard('partner-id')" class="
        px-2
        py-1
        ml-1
        basis-1/6
        rounded
        uppercase
        text-xs
        text-white
        bg-blue-600
        hover:bg-blue-700
        active:bg-blue-800
        focus:outline-none
        focus:ring
        focus:ring-blue-400
        ">
          copy
        </button>
      </div>
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      ">
        <label for="partner-client-id" class="
        flex-none
        basis-1/3
        ">
          Client ID
        </label>
        <input id="partner-client-id" name="partner-client-id" value="{{ partner_client_id }}" disabled class="
        appearance-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/5
        border
        rounded
        leading-none
        font-mono
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:border-blue-500
        ">
        <button type="button" onclick="copyToClipboard('partner-client-id')" class="
        px-2
        py-1
        ml-1
        basis-1/6
        rounded
        uppercase
        text-xs
        text-white
        bg-blue-600
        hover:bg-blue-700
        active:bg-blue-800
        focus:outline-none
        focus:ring
        focus:ring-blue-400
        ">
          copy
        </button>
      </div>
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      ">
        <label for="merchant-id" class="
        flex-none
        basis-1/3
        ">
          Merchant ID
        </label>
        <input id="merchant-id" name="merchant-id" value="{{ merchant_id }}" disabled class="
        appearance-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/5
        border
        rounded
        leading-none
        font-mono
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:border-blue-500
        ">
        <button type="button" onclick="copyToClipboard('merchant-id')" class="
        px-2
        py-1
        ml-1
        basis-1/6
        rounded
        uppercase
        text-xs
        text-white
        bg-blue-600
        hover:bg-blue-700
        active:bg-blue-800
        focus:outline-none
        focus:ring
        focus:ring-blue-400
        ">
          copy
        </button>
      </div>
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      ">
        <label for="bn-code" class="
        flex-none
        basis-1/3
        ">
          BN Code
        </label>
        <input id="bn-code" name="bn-code" value="{{ bn_code }}" disabled class="
        appearance-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/5
        border
        rounded
        leading-none
        font-mono
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:border-blue-500
        ">
        <button type="button" onclick="copyToClipboard('bn-code')" class="
        px-2
        py-1
        ml-1
        basis-1/6
        rounded
        uppercase
        text-xs
        text-white
        bg-blue-600
        hover:bg-blue-700
        active:bg-blue-800
        focus:outline-none
        focus:ring
        focus:ring-blue-400
        ">
          copy
        </button>
      </div>
    </div>
  </fieldset>
  {% block checkout_options %}
  {% endblock %}
  <fieldset>
    <legend class="block mb-2 font-semibold">Billing Agreement (BA) Info</legend>
    <div class="ml-2">
      <div class="flex flex-row flex-wrap items-center mb-2">
        <label for="ba-token" class="
        flex-none
        basis-1/3
        ">
          BA Token
        </label>
        <input id="ba-token" name="ba-token" class="
        appearance-none
        leading-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/3
        font-mono
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
      </div>
      <div class="flex flex-row flex-wrap items-center mb-2">
        <label for="ba-id" class="
        flex-none
        basis-1/3
        ">
          BA ID
        </label>
        <input id="ba-id" name="ba-id" class="
        appearance-none
        leading-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/3
        font-mono
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend class="block mb-2 font-semibold">
      Order options
    </legend>
    <div class="ml-2">
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="shipping-preference" class="basis-1/3">
          Shipping
        </label>
        <select name="shipping-preference" id="shipping-preference" class="
        leading-none
        px-2
        py-1
        basis-2/3
        grow
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
          <option value="NO_SHIPPING" selected>No shipping</option>
          <option value="GET_FROM_FILE">Get from file</option>
        </select>
      </div>
    </div>
  </fieldset>
  <fieldset>
    <legend class="block mb-2 font-semibold">
      Purchase unit options
    </legend>
    <div class="ml-2">
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="reference-id" class="
        flex-none
        basis-1/3
        ">
          Reference ID
        </label>
        <input id="reference-id" name="reference-id" placeholder="default" type="text" class="
        appearance-none
        leading-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/3
        font-mono
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
      </div>
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="partner-fee" class="
        flex-none
        basis-1/3
        ">
          Partner fee
        </label>
        <input id="partner-fee" type="number" name="partner-fee" value="0" class="
        appearance-none
        leading-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/3
        font-mono
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend class="block mb-2 font-semibold">
      Item options
    </legend>
    <div class="ml-2">
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="price" class="
        flex-none
        basis-1/3
        ">
          Price
        </label>
        <input id="price" type="number" name="price" value="3.14" class="
        appearance-none
        leading-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/3
        font-mono
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
      </div>
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <legend for="item-category" class="basis-1/3">
          Category
        </legend>
        <select name="item-category" id="item-category" class="
        leading-none
        px-2
        py-1
        basis-2/3
        grow
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
          <option value="None" selected>Unspecified</option>
          <option value="PHYSICAL_GOODS">Physical goods</option>
          <option value="DIGITAL_GOODS">Digital goods</option>
          <option value="DONATION">Donation</option>
        </select>
      </div>
      <div class="
      mb-2
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <legend for="disbursement-mode" class="basis-1/3">
          Disbursement
        </legend>
        <select name="disbursement-mode" id="disbursement-mode" class="
        leading-none
        px-2
        py-1
        basis-2/3
        grow
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
          <option value="INSTANT" selected>Instant</option>
          <option value="DELAYED">Delayed</option>
        </select>
      </div>
    </div>
  </fieldset>
  {% block additional_options %}
  {% endblock %}
</form>
{% endblock %}

{% block right_col %}
<div id="buttons-tabs">
  <!-- Buttons for tabs -->
  <div id="buttons">
    <ul class="
    flex
    flex-wrap
    text-center
    border-b
    mb-2
    text-zinc-600 dark:text-zinc-400
    border-zinc-300 dark:border-zinc-600
    ">
      <li class="mr-2">
        <a href="#" id="checkout" class="
        button
        inline-block
        p-4
        rounded-t-lg
        hover:text-zinc-700 dark:hover:text-zinc-300
        hover:bg-zinc-100 dark:hover:bg-zinc-700
        ">Checkout</a>
      </li>
      <li class="mr-2">
        <a href="#" id="api-calls" class="
        button
        inline-block
        p-4
        rounded-t-lg
        hover:text-zinc-700 dark:hover:text-zinc-300
        hover:bg-zinc-100 dark:hover:bg-zinc-700
        ">API Calls</a>
      </li>
    </ul>
  </div>

  <!-- Tabs -->
  <div id="tabs" class="w-100">
    <div id="tab-checkout" class="tab center hidden">
      <div class="
      rounded-b-md
      w-full
      top-0
      p-2
      ">
        {{ script_tag | safe }}
        {% block checkout %}
        {% endblock %}
      </div>
    </div>
    <div id="tab-api-calls" class="tab center hidden">
      <div id="api-calls-buttons-tabs">
        <!-- Buttons for tabs -->
        <div id="api-calls-buttons">
          <ul class="
          flex
          flex-wrap
          text-center
          border-b
          mb-2
          text-zinc-500 dark:text-zinc-500
          border-zinc-300 dark:border-zinc-600
          space-x-2
          ">
            <li>
              <a id="access-token" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              ">Access Token</a>
            </li>
            <li>
              <a id="client-token" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              hidden
              ">Client Token</a>
            </li>
            <li>
              <a id="create-billing-agreement-token" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              hidden
              ">Create BA Token</a>
            </li>
            <li>
              <a id="create-billing-agreement" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              hidden
              ">Create BA</a>
            </li>
            <li>
              <a id="create-order" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              ">Create Order</a>
            </li>
            <li>
              <a id="get-order" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              ">Get Order</a>
            </li>
            <li>
              <a id="authorize-order" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              hidden
              ">Authorize Order</a>
            </li>
            <li>
              <a id="capture-order" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              ">Capture Order</a>
            </li>
            <li>
              <a id="sdk-error" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              ">SDK Error</a>
            </li>
          </ul>
        </div>

        <!-- Tabs -->
        <div id="api-calls-tabs" class="font-mono dark:text-zinc-100">
          <div id="tab-access-token" class="tab center hidden">
            <div id="api-calls-access-token" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
          <div id="tab-client-token" class="tab center hidden">
            <div id="api-calls-client-token" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
          <div id="tab-create-billing-agreement-token" class="tab center hidden">
            <div id="api-calls-create-billing-agreement-token" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
          <div id="tab-create-billing-agreement" class="tab center hidden">
            <div id="api-calls-create-billing-agreement" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
          <div id="tab-create-order" class="tab center hidden">
            <div id="api-calls-create-order" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
          <div id="tab-get-order" class="tab center hidden">
            <div id="api-calls-get-order" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
          <div id="tab-authorize-order" class="tab center hidden">
            <div id="api-calls-authorize-order" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
          <div id="tab-capture-order" class="tab center hidden">
            <div id="api-calls-capture-order" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
          <div id="tab-sdk-error" class="tab center hidden">
            <div id="api-calls-sdk-error" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}