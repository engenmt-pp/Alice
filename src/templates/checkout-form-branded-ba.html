{% extends "checkout-base.html" %}

{% block checkout_options %}
<fieldset>
  <legend class="block mb-2 font-semibold">
    Meta
  </legend>
  <div class="ml-2">
    <div class="
    mb-2
    flex
    flex-row
    flex-wrap
    items-center
    justify-between
    ">
      <label for="api-caller" class="basis-1/3">
        API-caller
      </label>
      <select name="api-caller" id="api-caller" class="
      leading-none
      px-2
      py-1
      basis-2/3
      grow
      rounded
      border
      focus:outline-none
      bg-zinc-100 dark:bg-zinc-700
      border-zinc-300 dark:border-zinc-600
      focus:bg-white dark:focus:bg-zinc-900
      focus:border-blue-500 dark:focus:border-blue-500
      ">
        <option value="partner" selected>Partner</option>
        <option value="merchant">Merchant</option>
      </select>
    </div>
    <div class="
    mb-2
    flex
    flex-row
    flex-wrap
    items-center
    justify-between
    ">
      <label for="ba-type" class="basis-1/3">
        BA Type
      </label>
      <select name="ba-type" id="ba-type" class="
      leading-none
      px-2
      py-1
      basis-2/3
      grow
      rounded
      border
      focus:outline-none
      bg-zinc-100 dark:bg-zinc-700
      border-zinc-300 dark:border-zinc-600
      focus:bg-white dark:focus:bg-zinc-900
      focus:border-blue-500 dark:focus:border-blue-500
      ">
        <option value="CIB" selected>Channel-initiated</option>
        <option value="MIB">Merchant-initiated</option>
      </select>
    </div>
  </div>
</fieldset>
{% endblock %}

{% block foot %}

{{ super() }}

<script id="script-onchange-reload">
  const intent = document.getElementById('intent')
  intent.value = 'TOKENIZE';

  (function addOnChange() {
    const elementIDs = [
      'intent',
      'api-caller'
    ]
    for (const elementID of elementIDs) {
      const element = document.getElementById(elementID)
      element.addEventListener('change', (event) => {
        reloadCheckout()
      })
    }
  })();
</script>
{% endblock %}

{% block checkout %}
<!-- Empty (for now) button container -->
<div id="paypal-button-wrapper" class="text-center">
  <div id="paypal-button-container"></div>
</div>

<script>
  let billingAgreementToken
  let billingAgreementID
  let orderID
  let options
  function checkoutClosure() {
    let buttons
    async function loadCheckout() {
      buttons = await paypal.Buttons({
        createBillingAgreement: function (data, actions) {
          console.log("Creating billing agreement token...")
          options = getOptions()
          return fetch('/api/billing-form/create-billing-agreement-token', {
            headers: {'Content-Type': 'application/json'},
            method: 'POST',
            body: JSON.stringify(options),
          }).then(function(res) {
            return res.json();
          }).then(function(createData) {
            updateAPICalls(createData.formatted);
            if (createData.tokenId === null) {
              alert("No BA token ID returned! Is CIB enabled on both the API caller and merchant accounts?")
            } else {
              billingAgreementToken = createData.tokenId;
              document.getElementById('ba-token').value = billingAgreementToken;
              return billingAgreementToken;
            }
          })
        },
        onApprove: function (data, actions) {
          console.log("Creating billing agreement...")
          options = getOptions()
          return fetch('/api/billing-form/create-billing-agreement', {
            headers: {'Content-Type': 'application/json'},
            method: 'POST',
            body: JSON.stringify(options),
          }).then(function(res) {
            return res.json()
          }).then(function(createData) {
            updateAPICalls(createData.formatted)
            billingAgreementID = createData.billingAgreementID
            document.getElementById('ba-id').value = billingAgreementID
            return billingAgreementIDX
          })
        },
        onError: function (data, actions) {
          alert("An error with the JS SDK occurred! Check the console for more information.");
        },
      })
      return buttons
      .render('#paypal-button-container')
      .catch((err) => {
        console.log("Caught an error while rendering checkout:", err)
      })
    }
    async function reloadMyCheckout() {
      await buttons.close()
      await buildScriptElement(function() {
        resetCheckoutContainer()
        loadCheckout()
      })
    }
    buildScriptElement(loadCheckout)
    return reloadMyCheckout
  }
  const reloadCheckout = checkoutClosure()
</script>
{% endblock %}